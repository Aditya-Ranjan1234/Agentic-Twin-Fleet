<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agentic Twin Fleet Dashboard</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">Agentic Twin Fleet Dashboard</h1>
    <div id="vehicle-table" class="mb-5"></div>
    <h3>Vehicle Telemetry</h3>
    <div id="chart" style="height:400px;"></div>

    <h3 class="mt-5">Recent Agent Actions</h3>
    <div id="actions-table"></div>
  </div>

  <script>
    async function fetchVehicles() {
      const res = await fetch('/api/vehicles');
      return res.json();
    }

    function tableHTML(data) {
      if (data.length === 0) return '<p>No data available</p>';
      let header = Object.keys(data[0])
        .map((h) => `<th>${h}</th>`)  // simple header
        .join('');
      let rows = data
        .map(
          (row) =>
            `<tr onclick="showTimeseries('${row.vehicle_id}')">${Object.values(row)
              .map((v) => `<td>${v}</td>`)
              .join('')}</tr>`
        )
        .join('');
      return `<table class="table table-hover"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function refreshTable() {
      const data = await fetchVehicles();
      document.getElementById('vehicle-table').innerHTML = tableHTML(data);
    }

    async function showTimeseries(vehicleId) {
      const res = await fetch(`/api/vehicle/${vehicleId}/timeseries`);
      const ts = await res.json();
      if (ts.length === 0) {
        Plotly.react('chart', []);
        return;
      }
      const fields = Object.keys(ts[0]).filter((k) => k !== '_time');
      const traces = fields.map((field) => ({
        x: ts.map((d) => d._time),
        y: ts.map((d) => d[field]),
        mode: 'lines',
        name: field,
      }));
      Plotly.newPlot('chart', traces, { title: `Telemetry for ${vehicleId}` });
    }

    async function fetchActions() {
      const res = await fetch('/api/actions');
      return res.json();
    }

    function actionsHTML(list) {
      if (list.length === 0) return '<p>No recent actions</p>';
      const headerLabels = ['time','vehicle_id','agent','type','issue','value'];
      const header = headerLabels.map(h => `<th>${h}</th>`).join('');
      const rows = list.map(row => `
        <tr>
          <td>${row.time}</td>
          <td>${row.vehicle_id}</td>
          <td>${row.agent}</td>
          <td>${row.type}</td>
          <td>${row.issue}</td>
          <td>${row.value}</td>
        </tr>`).join('');
      return `<table class="table table-sm"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    async function refreshActions() {
      const list = await fetchActions();
      document.getElementById('actions-table').innerHTML = actionsHTML(list);
    }

    // Initial load and periodic refresh
    refreshTable();
    setInterval(refreshTable, 5000);
    refreshActions();
    setInterval(refreshActions, 7000);
  </script>
</body>
</html>
